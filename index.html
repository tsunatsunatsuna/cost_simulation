<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ã¾ã„ã®ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¯”è¼ƒ Pro v3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-rent: #16a34a;    /* è³ƒè²¸ï¼šç·‘ */
            --color-nm: #2563eb;      /* æ–°ãƒï¼šé’ */
            --color-om: #0ea5e9;      /* å¤ãƒï¼šæ°´è‰² */
            --color-nh: #ea580c;      /* æ–°æˆ¸ï¼šã‚ªãƒ¬ãƒ³ã‚¸ */
            --color-oh: #8b5cf6;      /* ä¸­æˆ¸ï¼šç´« */
            --secondary: #64748b;
            --bg: #f1f5f9;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: #1e293b; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { font-size: 1.4rem; color: #0f172a; text-align: center; margin-bottom: 1.5rem; }
        
        /* åŸºæœ¬è¨­å®šï¼šç‰©ä»¶ä¾¡æ ¼ã‚’ã“ã¡ã‚‰ã«é›†ç´„ */
        .section-title { font-size: 0.95rem; font-weight: bold; margin-bottom: 15px; color: #0f172a; border-left: 4px solid var(--secondary); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .field { margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: #475569; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        
        /* ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { padding: 10px; border: none; background: #e2e8f0; cursor: pointer; color: var(--secondary); border-radius: 8px; font-size: 0.85rem; flex: 1; font-weight: bold; white-space: nowrap; }
        
        .tab-btn[data-type="rent"].active { background: var(--color-rent); color: white; }
        .tab-btn[data-type="nm"].active { background: var(--color-nm); color: white; }
        .tab-btn[data-type="om"].active { background: var(--color-om); color: white; }
        .tab-btn[data-type="nh"].active { background: var(--color-nh); color: white; }
        .tab-btn[data-type="oh"].active { background: var(--color-oh); color: white; }

        /* æœˆã€…ã®æ”¯æ‰•ã„ç›®å®‰ï¼šæ¨ªç©ã¿ä¸Šã’ã‚°ãƒ©ãƒ• */
        .monthly-box { margin-top: 15px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0; }
        .monthly-total { font-size: 1.8rem; font-weight: bold; text-align: center; color: #0f172a; margin-bottom: 10px; }
        .mini-chart-wrapper { height: 60px; width: 100%; }
        
        .main-btn { width: 100%; padding: 16px; background: #0f172a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 15px; }
        
        .chart-container { position: relative; height: 400px; width: 100%; margin-top: 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .res-item { background: white; padding: 15px; border-radius: 8px; border-top: 4px solid #ddd; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ  ä½ã¾ã„ã®ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¯”è¼ƒ Pro v3</h1>

    <div class="card">
        <div class="section-title">1. ç‰©ä»¶ãƒ»ãƒ­ãƒ¼ãƒ³åŸºæœ¬è¨­å®š</div>
        <div class="grid">
            <div class="field"><label>ç‰©ä»¶ä¾¡æ ¼ (ï¼å€Ÿå…¥é¡/ä¸‡)</label><input type="number" id="base_price" value="6000" oninput="liveCalc()"></div>
            <div class="field"><label>é‡‘åˆ© (%)</label><input type="number" id="loan_rate" value="0.5" step="0.1" oninput="liveCalc()"></div>
            <div class="field"><label>è¿”æ¸ˆæœŸé–“ (å¹´)</label><input type="number" id="loan_term" value="35" oninput="liveCalc()"></div>
            <div class="field">
                <label>ãƒšã‚¢ãƒ­ãƒ¼ãƒ³è¨­å®š</label>
                <select id="is_pair" onchange="liveCalc()">
                    <option value="1">ãªã— (å˜ç‹¬)</option>
                    <option value="2">ã‚ã‚Š (äºŒäººã§æ§é™¤)</option>
                </select>
            </div>
            <div class="field">
                <label>æ¯”è¼ƒæœŸé–“ (å¹´)</label>
                <select id="sim_years">
                    <option value="35">35å¹´</option>
                    <option value="50" selected>50å¹´</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">2. ç¶­æŒè²»ãƒ»æ§é™¤ã®è¨­å®š</div>
        <div class="tabs" id="tabGroup">
            <button class="tab-btn active" data-type="rent" onclick="switchTab('rent', this)">è³ƒè²¸</button>
            <button class="tab-btn" data-type="nm" onclick="switchTab('nm', this)">æ–°ãƒ</button>
            <button class="tab-btn" data-type="om" onclick="switchTab('om', this)">å¤ãƒ</button>
            <button class="tab-btn" data-type="nh" onclick="switchTab('nh', this)">æ–°æˆ¸</button>
            <button class="tab-btn" data-type="oh" onclick="switchTab('oh', this)">ä¸­æˆ¸</button>
        </div>

        <div id="input-area" class="grid">
            </div>

        <div class="monthly-box">
            <div style="font-size:0.85rem; text-align:center; color:var(--secondary); margin-bottom:5px;">é¸æŠãƒ—ãƒ©ãƒ³ã®æœˆã€…æ”¯æ‰•ã„ç›®å®‰</div>
            <div class="monthly-total" id="live_monthly">-- ä¸‡å††</div>
            <div class="mini-chart-wrapper">
                <canvas id="miniChart"></canvas>
            </div>
        </div>
        <button class="main-btn" onclick="runSimulation()">ç”Ÿæ¶¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ</button>
    </div>

    <div id="resultArea" style="display:none;" class="card">
        <div class="section-title">3. ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆã®æ¨ç§»</div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div class="chart-container"><canvas id="mainChart"></canvas></div>
    </div>
</div>

<script>
    let activeTab = 'rent';
    let mainChart = null;
    let miniChart = null;

    const config = {
        rent: { label: 'è³ƒè²¸', color: '#16a34a' },
        nm: { label: 'æ–°ãƒ', color: '#2563eb' },
        om: { label: 'å¤ãƒ', color: '#0ea5e9' },
        nh: { label: 'æ–°æˆ¸', color: '#ea580c' },
        oh: { label: 'ä¸­æˆ¸', color: '#8b5cf6' }
    };

    function switchTab(type, btn) {
        activeTab = type;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderInputs();
        liveCalc();
    }

    function renderInputs() {
        const area = document.getElementById('input-area');
        let html = '';
        if(activeTab === 'rent') {
            html = `<div class="field"><label>å®¶è³ƒ (ä¸‡å††)</label><input type="number" id="val_rent" value="16" oninput="liveCalc()"></div>`;
        } else {
            if(activeTab.includes('o')) html += `<div class="field"><label>ãƒªãƒ•ã‚©ãƒ¼ãƒ è²»ç”¨ (ä¸‡)</label><input type="number" id="val_ref" value="1000" oninput="liveCalc()"></div>`;
            
            if(activeTab.includes('m')) {
                html += `<div class="field"><label>ç®¡ç†è²» (ä¸‡å††)</label><input type="number" id="val_maint" value="1.5" oninput="liveCalc()"></div>`;
                html += `<div class="field"><label>ä¿®ç¹•ç©ç«‹é‡‘ (ä¸‡å††)</label><input type="number" id="val_shuzen" value="1.8" oninput="liveCalc()"></div>`;
            } else {
                html += `<div class="field"><label>å°†æ¥ã®æƒ³å®šä¿®ç¹•ç·é¡ (ä¸‡)</label><input type="number" id="val_shuzen_total" value="450" oninput="liveCalc()"></div>`;
                html += `<div class="field"><label>ä¿®ç¹•ã‚¹ãƒ‘ãƒ³ (å¹´)</label><input type="number" id="val_span" value="15" oninput="liveCalc()"></div>`;
            }
            html += `<div class="field"><label>æ§é™¤åŒºåˆ†</label><select id="val_tax_type" onchange="liveCalc()"><option value="4500">é•·æœŸå„ªè‰¯ (4500ä¸‡æ )</option><option value="3500">ZEH (3500ä¸‡æ )</option><option value="2000">ä¸€èˆ¬/ä¸­å¤ (2000ä¸‡æ )</option></select></div>`;
        }
        area.innerHTML = html;
    }

    function getLoanMonthly(p, r, n) {
        if(r === 0) return p / (n * 12);
        const ir = r / 100 / 12;
        const im = n * 12;
        return p * ir * Math.pow(1 + ir, im) / (Math.pow(1 + ir, im) - 1);
    }

    function liveCalc() {
        const basePrice = parseFloat(document.getElementById('base_price').value || 0);
        let loan = 0, maint = 0, shuzen = 0;

        if(activeTab === 'rent') {
            loan = parseFloat(document.getElementById('val_rent')?.value || 0);
        } else {
            const rate = parseFloat(document.getElementById('loan_rate').value);
            const term = parseFloat(document.getElementById('loan_term').value);
            loan = getLoanMonthly(basePrice, rate, term);
            
            if(activeTab.includes('m')) {
                maint = parseFloat(document.getElementById('val_maint')?.value || 0);
                shuzen = parseFloat(document.getElementById('val_shuzen')?.value || 0);
            } else {
                const sTotal = parseFloat(document.getElementById('val_shuzen_total')?.value || 0);
                const span = parseFloat(document.getElementById('val_span')?.value || 1);
                shuzen = sTotal / (span * 12);
            }
        }
        const total = loan + maint + shuzen;
        document.getElementById('live_monthly').innerText = total.toFixed(1) + " ä¸‡å††";
        updateMiniChart(loan, maint, shuzen);
    }

    function updateMiniChart(l, m, s) {
        const ctx = document.getElementById('miniChart').getContext('2d');
        if(miniChart) miniChart.destroy();
        miniChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [
                    { label: 'ãƒ­ãƒ¼ãƒ³/å®¶è³ƒ', data: [l], backgroundColor: config[activeTab].color },
                    { label: 'ç®¡ç†è²»ç­‰', data: [m], backgroundColor: '#94a3b8' },
                    { label: 'ä¿®ç¹•è²»ç”¨', data: [s], backgroundColor: '#cbd5e1' }
                ]
            },
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false }, tooltip: { enabled: true } },
                scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } },
                maintainAspectRatio: false,
                responsive: true
            }
        });
    }

    function runSimulation() {
        document.getElementById('resultArea').style.display = 'block';
        const years = parseInt(document.getElementById('sim_years').value);
        const basePrice = parseFloat(document.getElementById('base_price').value);
        const loanRate = parseFloat(document.getElementById('loan_rate').value);
        const loanTerm = parseInt(document.getElementById('loan_term').value);
        const pairFactor = parseInt(document.getElementById('is_pair').value);

        let datasets = [];
        let summaryHtml = '';

        Object.keys(config).forEach(id => {
            let history = [];
            let total = 0;
            let loanRemain = basePrice;
            const loanM = getLoanMonthly(basePrice, loanRate, loanTerm);

            // ç°¡æ˜“ç¨åˆ¶ãƒ»ç¶­æŒè²»ãƒ­ã‚¸ãƒƒã‚¯
            for(let y=1; y<=years; y++) {
                if(id === 'rent') {
                    total += (16 * 12); // å®¶è³ƒ
                    if(y % 2 === 0) total += 16; // æ›´æ–°æ–™
                } else {
                    // ãƒ­ãƒ¼ãƒ³æ”¯æ‰•ã„
                    if(y <= loanTerm) total += (loanM * 12);
                    // ç¶­æŒè²» (ãƒãƒ³ã‚·ãƒ§ãƒ³ã¯å…¥åŠ›å€¤ã€æˆ¸å»ºã¯ä¿®ç¹•è²»+å›ºå®šè³‡ç”£ç¨æ¦‚ç®—)
                    if(id.includes('m')) {
                        total += (1.5 + 1.8) * 12; 
                    } else {
                        total += (450/15) + 12; // å¹´é–“ä¿®ç¹•+å›ºå®šè³‡ç”£ç¨12ä¸‡
                    }
                    // ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ (æœ€å¤§13å¹´, 0.7%, ãƒšã‚¢ãƒ­ãƒ¼ãƒ³ã§æ å¤‰å‹•)
                    if(y <= 13) {
                        let taxCredit = Math.min(loanRemain, 3500 * pairFactor) * 0.007;
                        total -= taxCredit;
                    }
                    loanRemain -= (loanM * 12 - (loanRemain * loanRate/100)); // ç°¡æ˜“æ®‹é«˜è¨ˆç®—
                }
                history.push(Math.round(total));
            }

            datasets.push({
                label: config[id].label,
                data: history,
                borderColor: config[id].color,
                backgroundColor: config[id].color,
                borderWidth: id === activeTab ? 4 : 2,
                tension: 0.1,
                pointRadius: 0
            });

            summaryHtml += `
                <div class="res-item" style="border-top-color:${config[id].color}">
                    <div style="font-size:0.75rem; color:var(--secondary)">${config[id].label} (ç´¯è¨ˆ)</div>
                    <div style="font-size:1.1rem; font-weight:bold">${total.toLocaleString()}ä¸‡å††</div>
                </div>`;
        });

        const ctx = document.getElementById('mainChart').getContext('2d');
        if(mainChart) mainChart.destroy();
        mainChart = new Chart(ctx, {
            type: 'line',
            data: { labels: Array.from({length: years}, (_, i) => i + 1 + "å¹´"), datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        title: { display: true, text: 'ç´¯è¨ˆæ”¯å‡º (ä¸‡å††)' },
                        ticks: { callback: value => value.toLocaleString() + 'ä¸‡' }
                    }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
        document.getElementById('summaryGrid').innerHTML = summaryHtml;
        document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
    }

    window.onload = () => { renderInputs(); liveCalc(); };
</script>

</body>
</html>
