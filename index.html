<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ã¾ã„ã®ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¯”è¼ƒ Pro v4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-rent: #16a34a; --color-nm: #2563eb; --color-om: #0ea5e9;
            --color-nh: #ea580c; --color-oh: #8b5cf6; --secondary: #64748b; --bg: #f1f5f9;
        }
        body { font-family: -apple-system, sans-serif; color: #1e293b; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; position: relative; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚¤ãƒ³ãƒ•ã‚© */
        .header-area { display: flex; justify-content: center; align-items: center; margin-bottom: 1.5rem; position: relative; }
        h1 { font-size: 1.3rem; margin: 0; }
        .top-info-btn { position: absolute; right: 0; top: 0; background: var(--secondary); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .field { margin-bottom: 8px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: #475569; display: flex; align-items: center; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; gap: 4px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 12px 8px; border: none; background: #e2e8f0; cursor: pointer; color: var(--secondary); border-radius: 8px; font-size: 0.8rem; flex: 1; font-weight: bold; white-space: nowrap; }
        .tab-btn[data-type="rent"].active { background: var(--color-rent); color: white; }
        .tab-btn[data-type="nm"].active { background: var(--color-nm); color: white; }
        .tab-btn[data-type="om"].active { background: var(--color-om); color: white; }
        .tab-btn[data-type="nh"].active { background: var(--color-nh); color: white; }
        .tab-btn[data-type="oh"].active { background: var(--color-oh); color: white; }

        /* æœˆã€…è¡¨ç¤º */
        .monthly-box { margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0; text-align: center; }
        .monthly-total { font-size: 1.6rem; font-weight: bold; color: #0f172a; }
        
        .main-btn { width: 100%; padding: 16px; background: #0f172a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 15px; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .info-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
        .info-table th, .info-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
        .info-table th { background: #f8fafc; }
        .close-btn { background: #64748b; color: white; border: none; padding: 10px; width: 100%; border-radius: 6px; margin-top: 15px; cursor: pointer; }

        .info-trigger { margin-left: 6px; background: #94a3b8; color: white; border: none; width: 18px; height: 18px; border-radius: 50%; font-size: 11px; cursor: pointer; }

        /* çµæœã‚¨ãƒªã‚¢ */
        .chart-container { height: 350px; margin: 20px 0; }
        .res-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        .res-table th, .res-table td { border-bottom: 1px solid #e2e8f0; padding: 12px; text-align: right; }
        .res-table th { text-align: left; color: var(--secondary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h1>ğŸ  ä½ã¾ã„ã®ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¯”è¼ƒ Pro v4</h1>
        <button class="top-info-btn" onclick="openModal('formula')">?</button>
    </div>

    <div class="card">
        <label style="font-weight:bold; color:var(--secondary); margin-bottom:10px;">1. å…±é€šãƒ­ãƒ¼ãƒ³ãƒ»æœŸé–“è¨­å®š</label>
        <div class="grid">
            <div class="field"><label>æ¯”è¼ƒå¹´æ•°</label><select id="sim_years"><option value="35">35å¹´</option><option value="50" selected>50å¹´</option></select></div>
            <div class="field"><label>é‡‘åˆ© (%)</label><input type="number" id="global_rate" value="0.5" step="0.1" oninput="liveCalc()"></div>
            <div class="field"><label>ãƒ­ãƒ¼ãƒ³æœŸé–“ (å¹´)</label><input type="number" id="global_term" value="35" oninput="liveCalc()"></div>
            <div class="field">
                <label>ãƒšã‚¢ãƒ­ãƒ¼ãƒ³è¨­å®š</label>
                <select id="is_pair" onchange="liveCalc()">
                    <option value="1">å˜ç‹¬ãƒ­ãƒ¼ãƒ³</option>
                    <option value="2">ãƒšã‚¢ãƒ­ãƒ¼ãƒ³ (æ§é™¤æ 2å€)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="tabs" id="tabGroup">
            <button class="tab-btn active" data-type="rent" onclick="switchTab('rent', this)">è³ƒè²¸</button>
            <button class="tab-btn" data-type="nm" onclick="switchTab('nm', this)">æ–°ãƒ</button>
            <button class="tab-btn" data-type="om" onclick="switchTab('om', this)">å¤ãƒ</button>
            <button class="tab-btn" data-type="nh" onclick="switchTab('nh', this)">æ–°æˆ¸</button>
            <button class="tab-btn" data-type="oh" onclick="switchTab('oh', this)">ä¸­æˆ¸</button>
        </div>

        <div id="input-area" class="grid"></div>

        <div class="monthly-box">
            <div class="monthly-total" id="live_monthly">-- ä¸‡å††</div>
            <div style="height: 40px; margin-top:10px;"><canvas id="miniChart"></canvas></div>
        </div>
        <button class="main-btn" onclick="runSimulation()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
    </div>

    <div id="resultArea" style="display:none;" class="card">
        <label style="font-weight:bold; color:var(--secondary);">3. ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆã®æ¨ç§»</label>
        <div class="chart-container"><canvas id="mainChart"></canvas></div>
        <table class="res-table" id="resTable">
            <thead><tr><th>ãƒ—ãƒ©ãƒ³</th><th>åˆæœŸè²»ç”¨ç­‰</th><th>æ§é™¤åˆè¨ˆ</th><th>ç·æ”¯æ‰•é¡</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="modal-tax" class="modal"><div class="modal-content" id="tax-content"></div></div>
<div id="modal-formula" class="modal"><div class="modal-content" id="formula-content"></div></div>

<script>
    let activeTab = 'rent';
    let mainChart = null, miniChart = null;

    // å„ã‚¿ãƒ–ã®å…¥åŠ›å€¤ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const store = {
        rent: { price: 16, taxType: 'none' },
        nm: { price: 6000, maint: 1.5, shuzen: 1.8, taxType: '3500' },
        om: { price: 4500, ref: 1000, maint: 1.8, shuzen: 2.2, taxType: '2000' },
        nh: { price: 5500, shuzen_total: 450, span: 15, taxType: '3500' },
        oh: { price: 3800, ref: 1000, shuzen_total: 500, span: 15, taxType: '2000' }
    };

    const config = {
        rent: { label: 'è³ƒè²¸', color: '#16a34a' },
        nm: { label: 'æ–°ãƒ', color: '#2563eb' },
        om: { label: 'å¤ãƒ', color: '#0ea5e9' },
        nh: { label: 'æ–°æˆ¸', color: '#ea580c' },
        oh: { label: 'ä¸­æˆ¸', color: '#8b5cf6' }
    };

    function switchTab(type, btn) {
        saveCurrentValues(); // ç¾åœ¨ã®å€¤ã‚’storeã¸é€€é¿
        activeTab = type;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderInputs();
        liveCalc();
    }

    function saveCurrentValues() {
        if(activeTab === 'rent') {
            store.rent.price = parseFloat(document.getElementById('val_price')?.value || 0);
        } else {
            const s = store[activeTab];
            s.price = parseFloat(document.getElementById('val_price')?.value || 0);
            if(document.getElementById('val_ref')) s.ref = parseFloat(document.getElementById('val_ref').value);
            if(document.getElementById('val_maint')) s.maint = parseFloat(document.getElementById('val_maint').value);
            if(document.getElementById('val_shuzen')) s.shuzen = parseFloat(document.getElementById('val_shuzen').value);
            if(document.getElementById('val_shuzen_total')) s.shuzen_total = parseFloat(document.getElementById('val_shuzen_total').value);
            if(document.getElementById('val_span')) s.span = parseFloat(document.getElementById('val_span').value);
            if(document.getElementById('val_tax_type')) s.taxType = document.getElementById('val_tax_type').value;
        }
    }

    function renderInputs() {
        const area = document.getElementById('input-area');
        const s = store[activeTab];
        let html = '';

        if(activeTab === 'rent') {
            html = `<div class="field"><label>å®¶è³ƒ (ä¸‡å††)</label><input type="number" id="val_price" value="${s.price}" oninput="liveCalc()"></div>`;
        } else {
            html += `<div class="field"><label>ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††)</label><input type="number" id="val_price" value="${s.price}" oninput="liveCalc()"></div>`;
            if(activeTab.includes('o')) html += `<div class="field"><label>ãƒªãƒ•ã‚©ãƒ¼ãƒ è²»ç”¨ (ä¸‡)</label><input type="number" id="val_ref" value="${s.ref}" oninput="liveCalc()"></div>`;
            
            if(activeTab.includes('m')) {
                html += `<div class="field"><label>ç®¡ç†è²» (ä¸‡å††)</label><input type="number" id="val_maint" value="${s.maint}" oninput="liveCalc()"></div>`;
                html += `<div class="field"><label>ä¿®ç¹•ç©ç«‹é‡‘ (ä¸‡å††)</label><input type="number" id="val_shuzen" value="${s.shuzen}" oninput="liveCalc()"></div>`;
            } else {
                html += `<div class="field"><label>å°†æ¥ä¿®ç¹•ç·é¡ (ä¸‡)</label><input type="number" id="val_shuzen_total" value="${s.shuzen_total}" oninput="liveCalc()"></div>`;
                html += `<div class="field"><label>ä¿®ç¹•ã‚¹ãƒ‘ãƒ³ (å¹´)</label><input type="number" id="val_span" value="${s.span}" oninput="liveCalc()"></div>`;
            }
            html += `
                <div class="field">
                    <label>ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤åŒºåˆ† <button class="info-trigger" onclick="openModal('tax')">?</button></label>
                    <select id="val_tax_type" onchange="liveCalc()">
                        <option value="4500" ${s.taxType==='4500'?'selected':''}>é•·æœŸå„ªè‰¯ (4500ä¸‡)</option>
                        <option value="3500" ${s.taxType==='3500'?'selected':''}>ZEH (3500ä¸‡)</option>
                        <option value="3000" ${s.taxType==='3000'?'selected':''}>çœã‚¨ãƒé©åˆ (3000ä¸‡)</option>
                        <option value="2000" ${s.taxType==='2000'?'selected':''}>ä¸€èˆ¬/æ—¢å­˜ä¸­å¤ (2000ä¸‡)</option>
                        <option value="0" ${s.taxType==='0'?'selected':''}>å¯¾è±¡å¤–</option>
                    </select>
                </div>`;
        }
        area.innerHTML = html;
    }

    function liveCalc() {
        const price = parseFloat(document.getElementById('val_price')?.value || 0);
        const rate = parseFloat(document.getElementById('global_rate').value);
        const term = parseFloat(document.getElementById('global_term').value);
        let loan = 0, maint = 0, shuzen = 0;

        if(activeTab === 'rent') {
            loan = price;
        } else {
            loan = getLoanMonthly(price, rate, term);
            if(activeTab.includes('m')) {
                maint = parseFloat(document.getElementById('val_maint')?.value || 0);
                shuzen = parseFloat(document.getElementById('val_shuzen')?.value || 0);
            } else {
                const sTotal = parseFloat(document.getElementById('val_shuzen_total')?.value || 0);
                const span = parseFloat(document.getElementById('val_span')?.value || 1);
                shuzen = sTotal / (span * 12);
            }
        }
        document.getElementById('live_monthly').innerText = (loan + maint + shuzen).toFixed(1) + " ä¸‡å††";
        updateMiniChart(loan, maint, shuzen);
    }

    function getLoanMonthly(p, r, n) {
        if(r === 0) return p / (n * 12);
        const ir = r / 100 / 12, im = n * 12;
        return p * ir * Math.pow(1 + ir, im) / (Math.pow(1 + ir, im) - 1);
    }

    function updateMiniChart(l, m, s) {
        const ctx = document.getElementById('miniChart').getContext('2d');
        if(miniChart) miniChart.destroy();
        miniChart = new Chart(ctx, {
            type: 'bar', indexAxis: 'y',
            data: { labels: [''], datasets: [
                { label: 'ãƒ­ãƒ¼ãƒ³/å®¶è³ƒ', data: [l], backgroundColor: config[activeTab].color },
                { label: 'ç®¡ç†è²»ç­‰', data: [m], backgroundColor: '#94a3b8' },
                { label: 'ä¿®ç¹•è²»ç”¨', data: [s], backgroundColor: '#cbd5e1' }
            ]},
            options: { plugins: { legend: { display: false } }, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } }, maintainAspectRatio: false }
        });
    }

    function runSimulation() {
        saveCurrentValues();
        document.getElementById('resultArea').style.display = 'block';
        const years = parseInt(document.getElementById('sim_years').value);
        const pair = parseInt(document.getElementById('is_pair').value);
        const gRate = parseFloat(document.getElementById('global_rate').value);
        const gTerm = parseInt(document.getElementById('global_term').value);

        let datasets = [], tableRows = '';

        Object.keys(config).forEach(id => {
            const s = store[id];
            let history = [], total = 0, totalTax = 0;
            const loanM = getLoanMonthly(s.price, gRate, gTerm);
            let loanRemain = s.price;
            const initCost = id === 'rent' ? s.price * 5 : s.price * 0.07 + (s.ref || 0);

            total = initCost;
            for(let y=1; y<=years; y++) {
                if(id === 'rent') {
                    total += (s.price * 12);
                    if(y % 2 === 0) total += s.price;
                } else {
                    if(y <= gTerm) total += (loanM * 12);
                    total += id.includes('m') ? (s.maint + s.shuzen) * 12 : (s.shuzen_total / s.span) + 12;
                    // ãƒ­ãƒ¼ãƒ³æ§é™¤
                    const limit = parseInt(s.taxType);
                    const period = id.includes('n') ? 13 : 10;
                    if(y <= period && limit > 0) {
                        let taxCredit = Math.min(loanRemain, limit * pair) * 0.007;
                        total -= taxCredit;
                        totalTax += taxCredit;
                    }
                    loanRemain -= (loanM * 12 - (loanRemain * gRate/100));
                }
                history.push(Math.round(total));
            }
            datasets.push({ label: config[id].label, data: history, borderColor: config[id].color, pointRadius: 0, tension: 0.1 });
            tableRows += `<tr><td>${config[id].label}</td><td>${Math.round(initCost)}ä¸‡</td><td>${Math.round(totalTax)}ä¸‡</td><td style="font-weight:bold">${Math.round(total).toLocaleString()}ä¸‡</td></tr>`;
        });

        const ctx = document.getElementById('mainChart').getContext('2d');
        if(mainChart) mainChart.destroy();
        mainChart = new Chart(ctx, {
            type: 'line', data: { labels: Array.from({length: years}, (_, i) => i + 1 + "å¹´"), datasets: datasets },
            options: { scales: { y: { ticks: { callback: v => v.toLocaleString() + 'ä¸‡' } } }, maintainAspectRatio: false }
        });
        document.getElementById('resTable').querySelector('tbody').innerHTML = tableRows;
        document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
    }

    function openModal(type) {
        const modal = document.getElementById('modal-' + type);
        const content = document.getElementById(type + '-content');
        if(type === 'tax') {
            content.innerHTML = `<h3>ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ (2026å¹´å…¥å±…)</h3>
                <strong>ã€æ–°ç¯‰ä½å®…ã€‘(13å¹´)</strong><table class="info-table">
                <tr><th>åŒºåˆ†</th><th>æ®‹é«˜ä¸Šé™</th><th>å¹´é–“æœ€å¤§</th><th>ç·é¡ç›®å®‰</th></tr>
                <tr><td>é•·æœŸå„ªè‰¯ãƒ»ä½ç‚­ç´ </td><td>4,500ä¸‡</td><td>31.5ä¸‡</td><td>409.5ä¸‡</td></tr>
                <tr><td>ZEHæ°´æº–</td><td>3,500ä¸‡</td><td>24.5ä¸‡</td><td>318.5ä¸‡</td></tr>
                <tr><td>çœã‚¨ãƒåŸºæº–é©åˆ</td><td>3,000ä¸‡</td><td>21ä¸‡</td><td>273ä¸‡</td></tr>
                </table>
                <strong style="display:block;margin-top:10px;">ã€ä¸­å¤ä½å®…ã€‘(10å¹´)</strong><table class="info-table">
                <tr><th>åŒºåˆ†</th><th>æ®‹é«˜ä¸Šé™</th><th>å¹´é–“æœ€å¤§</th><th>ç·é¡ç›®å®‰</th></tr>
                <tr><td>é•·æœŸå„ªè‰¯/çœã‚¨ãƒé©åˆ</td><td>3,000ä¸‡</td><td>21ä¸‡</td><td>210ä¸‡</td></tr>
                <tr><td>ä¸€èˆ¬ä¸­å¤(è€éœ‡æœ‰)</td><td>2,000ä¸‡</td><td>14ä¸‡</td><td>140ä¸‡</td></tr>
                </table><button class="close-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>`;
        } else {
            content.innerHTML = `<h3>ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—å¼</h3>
                <ul>
                    <li><strong>ä½å®…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆé¡:</strong> å…ƒåˆ©å‡ç­‰è¿”æ¸ˆæ–¹å¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚</li>
                    <li><strong>åˆæœŸè²»ç”¨:</strong> è³¼å…¥æ™‚ã¯ç‰©ä»¶ä¾¡æ ¼ã®7%+ãƒªãƒ•ã‚©ãƒ¼ãƒ ä»£ã€è³ƒè²¸ã¯å®¶è³ƒã®5ãƒ¶æœˆåˆ†ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚</li>
                    <li><strong>ç´¯ç©ã‚³ã‚¹ãƒˆ:</strong> (ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ + ç¶­æŒè²» - ãƒ­ãƒ¼ãƒ³æ§é™¤) ã‚’æ¯å¹´ç©ã¿ä¸Šã’ã¦ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</li>
                </ul><button class="close-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>`;
        }
        modal.style.display = 'flex';
    }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    window.onload = () => { renderInputs(); liveCalc(); };
</script>
</body>
</html>
