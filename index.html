<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ã¾ã„ã®ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¯”è¼ƒ Pro v16</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-rent: #16a34a; --color-nm: #2563eb; --color-om: #0ea5e9;
            --color-nh: #ea580c; --color-oh: #8b5cf6; --secondary: #64748b; --bg: #f1f5f9;
        }
        body { font-family: -apple-system, sans-serif; color: #1e293b; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: #475569; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { padding: 12px 8px; border: none; background: #e2e8f0; cursor: pointer; border-radius: 8px; font-size: 0.8rem; flex: 1; font-weight: bold; white-space: nowrap; }
        .tab-btn.active { color: white; }
        .tab-btn[data-type="rent"].active { background: var(--color-rent); }
        .tab-btn[data-type="nm"].active { background: var(--color-nm); }
        .tab-btn[data-type="om"].active { background: var(--color-om); }
        .tab-btn[data-type="nh"].active { background: var(--color-nh); }
        .tab-btn[data-type="oh"].active { background: var(--color-oh); }

        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 10px; }
        .comp-item { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .comp-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .comp-value { font-size: 1.1rem; font-weight: bold; text-align: right; }

        .res-table { width: 100%; border-collapse: collapse; font-size: 0.65rem; min-width: 950px; margin-top: 15px;}
        .res-table th, .res-table td { border-bottom: 1px solid #e2e8f0; padding: 10px 6px; text-align: right; }
        .res-table th { background: #f8fafc; color: var(--secondary); }
        .res-table .row-label { text-align: left; font-weight: bold; font-size: 0.8rem; padding-left: 10px; border-left: 6px solid transparent; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 850px; max-height: 85vh; overflow-y: auto; }
        .info-btn { background: var(--secondary); color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .close-btn { background: #0f172a; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; margin-top: 15px; cursor: pointer; }
        
        .section-title { font-size: 1.1rem; font-weight: bold; margin: 20px 0 10px; border-left: 4px solid #0f172a; padding-left: 10px; }
        .chart-controls { display: flex; gap: 15px; margin-bottom: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; font-size: 0.85rem; }
        .tax-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin: 10px 0; }
        .tax-table th, .tax-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        .tax-table th { background: #f1f5f9; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center">ğŸ  ä½ã¾ã„ã®ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¯”è¼ƒ Pro v16</h1>

    <div class="card">
        <div class="section-title">1. åŸºæœ¬ãƒ­ãƒ¼ãƒ³ãƒ»ä¸–å¸¯è¨­å®š</div>
        <div class="grid">
            <div class="field"><label>é‡‘åˆ© (%)</label><input type="number" id="global_rate" value="1.5" step="0.1" oninput="liveCalc()"></div>
            <div class="field"><label>è¿”æ¸ˆæœŸé–“ (å¹´)</label><input type="number" id="global_term" value="35" oninput="liveCalc()"></div>
            <div class="field"><label>ä¸–å¸¯åŒºåˆ†</label><select id="is_child" onchange="liveCalc()"><option value="0">é€šå¸¸ä¸–å¸¯</option><option value="1" selected>å­è‚²ã¦ãƒ»è‹¥å¤«å©¦</option></select></div>
            <div class="field"><label>ãƒ­ãƒ¼ãƒ³å½¢æ…‹</label><select id="is_pair" onchange="liveCalc()"><option value="1">å˜ç‹¬ãƒ­ãƒ¼ãƒ³</option><option value="2" selected>ãƒšã‚¢ãƒ­ãƒ¼ãƒ³</option></select></div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">2. å„ãƒ—ãƒ©ãƒ³ã®æ¡ä»¶å…¥åŠ›</div>
        <div class="tabs" id="tabGroup">
            <button class="tab-btn active" data-type="rent" onclick="switchTab('rent', this)">è³ƒè²¸</button>
            <button class="tab-btn" data-type="nm" onclick="switchTab('nm', this)">æ–°ç¯‰ãƒãƒ³</button>
            <button class="tab-btn" data-type="om" onclick="switchTab('om', this)">ä¸­å¤ãƒãƒ³</button>
            <button class="tab-btn" data-type="nh" onclick="switchTab('nh', this)">æ–°ç¯‰æˆ¸å»º</button>
            <button class="tab-btn" data-type="oh" onclick="switchTab('oh', this)">ä¸­å¤æˆ¸å»º</button>
        </div>
        <div id="input-area" class="grid"></div>
        <button style="width:100%; padding:18px; background:#0f172a; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1.1rem; font-weight:bold; margin-top:20px;" onclick="runSimulation()">å…¨ãƒ—ãƒ©ãƒ³ã‚’æ¯”è¼ƒè¨ˆç®—ã™ã‚‹</button>
    </div>

    <div class="card">
        <div class="section-title">3. æœˆé¡ã‚³ã‚¹ãƒˆå†…è¨³ã®æ¯”è¼ƒ (æ¦‚ç®—)</div>
        <div class="comparison-grid" id="comp_grid"></div>
    </div>

    <div id="resultArea" style="display:none;" class="card">
        <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
            4. ç”Ÿæ¶¯ã‚³ã‚¹ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•
            <button class="info-btn" onclick="openModal('logic')">i</button>
        </div>
        <div class="chart-controls">
            <span>è¡¨ç¤ºè¨­å®š:</span>
            <label style="display:inline-flex; align-items:center; cursor:pointer;"><input type="checkbox" id="show_gross" checked onchange="runSimulation()"> <span style="margin-left:5px;">è² æ‹…é¡ç´¯è¨ˆ (å®Ÿç·š)</span></label>
            <label style="display:inline-flex; align-items:center; cursor:pointer;"><input type="checkbox" id="show_net" checked onchange="runSimulation()"> <span style="margin-left:5px;">å®Ÿè³ªç·è² æ‹…é¡ (ç‚¹ç·š)</span></label>
        </div>
        <div style="height: 400px; margin: 15px 0;"><canvas id="mainChart"></canvas></div>
        
        <div class="section-title">5. è©³ç´°æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿</div>
        <div style="background:#fff7ed; padding:15px; border-radius:8px; border:1px solid #fb923c; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
            <label style="margin:0; font-size:1rem;">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ç‚¹:</label>
            <select id="exit_year" style="width:auto; font-weight:bold;" onchange="runSimulation()">
                <option value="5">5å¹´ç›®</option><option value="10">10å¹´ç›®</option><option value="15">15å¹´ç›®</option><option value="20">20å¹´ç›®</option>
                <option value="25">25å¹´ç›®</option><option value="30">30å¹´ç›®</option><option value="35" selected>35å¹´ç›®</option><option value="40">40å¹´ç›®</option><option value="50">50å¹´ç›®</option>
            </select>
        </div>
        <div style="overflow-x:auto;">
            <table class="res-table" id="resTable">
                <thead>
                    <tr>
                        <th style="text-align:left">æ¯”è¼ƒãƒ—ãƒ©ãƒ³</th>
                        <th>ãƒ­ãƒ¼ãƒ³æ”¯æ‰•ç´¯è¨ˆ</th>
                        <th>åˆæœŸè²»ç”¨</th>
                        <th>ç¶­æŒè²»ç´¯è¨ˆ</th>
                        <th>æ§é™¤ç´¯è¨ˆ</th>
                        <th style="background:#fff7ed">æƒ³å®šå£²å´ä¾¡æ ¼</th>
                        <th style="background:#f0f9ff; color:#0f172a;">å®Ÿè³ªç·è² æ‹…é¡</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modal-logic" class="modal">
    <div class="modal-content">
        <h3>ğŸ“Š ç®—å‡ºå®šç¾©ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶</h3>
        
        <p><b>â–  åŸºæœ¬è¨ˆç®—å¼</b></p>
        <div style="background:#f1f5f9; padding:15px; border-radius:8px; font-size:0.8rem; line-height:1.6;">
            <b>1. è² æ‹…é¡ç´¯è¨ˆ (å®Ÿç·š)</b> = åˆæœŸè²»ç”¨ + ãƒ­ãƒ¼ãƒ³æ”¯æ‰•ç´¯è¨ˆ(å…ƒåˆ©) + ç¶­æŒè²»ç´¯è¨ˆ + å›ºå®šè³‡ç”£ç¨ç´¯è¨ˆ<br>
            <b>2. å®Ÿè³ªç·è² æ‹…é¡ (ç‚¹ç·š)</b> = è² æ‹…é¡ç´¯è¨ˆ - (æƒ³å®šå£²å´ä¾¡æ ¼ + ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ç´¯è¨ˆ)<br><br>
            â€»å®Ÿè³ªç·è² æ‹…é¡ã¯ã€ã€Œãã®æ™‚ç‚¹ã§ç‰©ä»¶ã‚’å£²å´ã—ãŸã¨ä»®å®šã—ãŸå ´åˆã€ãƒˆãƒ¼ã‚¿ãƒ«ã§ã„ãã‚‰å¤±ã£ãŸã‹ã€ã‚’ç¤ºã™æç›Šåˆ†å²æŒ‡æ¨™ã§ã™ã€‚
        </div>

        <p><b>â–  ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ (2026å¹´æ”¹æ­£å¯¾å¿œ)</b></p>
        <table class="tax-table">
            <thead><tr><th>ç‰©ä»¶åŒºåˆ†</th><th>é€šå¸¸é™åº¦é¡</th><th>å­è‚²ã¦/è‹¥å¤«å©¦</th><th>æœŸé–“</th></tr></thead>
            <tbody>
                <tr><td>é•·æœŸå„ªè‰¯ä½å®…</td><td>4,500ä¸‡å††</td><td>5,000ä¸‡å††</td><td>13å¹´</td></tr>
                <tr><td>ZEHæ°´æº–</td><td>3,500ä¸‡å††</td><td>4,500ä¸‡å††</td><td>13å¹´</td></tr>
                <tr><td>çœã‚¨ãƒé©åˆ</td><td>3,000ä¸‡å††</td><td>4,000ä¸‡å††</td><td>13å¹´</td></tr>
                <tr><td>ä¸­å¤(çœã‚¨ãƒä»¥ä¸Š)</td><td colspan="2">3,000ä¸‡å††</td><td>10å¹´</td></tr>
                <tr><td>ä¸­å¤(ãã®ä»–)</td><td colspan="2">2,000ä¸‡å††</td><td>10å¹´</td></tr>
            </tbody>
        </table>

        <p><b>â–  è³‡ç”£ä¾¡å€¤(å£²å´ä¾¡æ ¼)ã®æ¨ç§»è¨­å®š</b></p>
        <table class="tax-table">
            <thead><tr><th>åŒºåˆ†</th><th>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¸›ä¾¡ç‡</th><th>æ®‹ä¾¡ä¸‹é™(åº•å€¤)</th></tr></thead>
            <tbody>
                <tr><td>æ–°ç¯‰ãƒãƒ³ã‚·ãƒ§ãƒ³</td><td>1.8% / å¹´</td><td>è³¼å…¥ä¾¡æ ¼ã® 50%</td></tr>
                <tr><td>ä¸­å¤ãƒãƒ³ã‚·ãƒ§ãƒ³</td><td>1.2% / å¹´</td><td>è³¼å…¥ä¾¡æ ¼ã® 60%</td></tr>
                <tr><td>æ–°ç¯‰æˆ¸å»ºã¦</td><td>3.5% / å¹´</td><td>è³¼å…¥ä¾¡æ ¼ã® 50%</td></tr>
                <tr><td>ä¸­å¤æˆ¸å»ºã¦</td><td>2.0% / å¹´</td><td>è³¼å…¥ä¾¡æ ¼ã® 65%</td></tr>
            </tbody>
        </table>

        <p><b>â–  ç¶­æŒè²»ã®è¨ˆç®—è©³ç´°</b></p>
        <div style="font-size: 0.8rem; line-height: 1.5;">
            * <b>ãƒãƒ³ã‚·ãƒ§ãƒ³</b>: ç®¡ç†è²» + ä¿®ç¹•ç©ç«‹é‡‘ã€‚ç©ç«‹é‡‘ã¯ã€Œä¿®ç¹•ä¸Šæ˜‡ç‡ã€ã«åŸºã¥ãæ¯å¹´è¤‡åˆ©ã§å¢—åŠ ã™ã‚‹ã¨ä»®å®šã€‚<br>
            * <b>æˆ¸å»ºã¦</b>: ã€Œä¿®ç¹•ç·é¡ã€ã‚’ã€Œä¿®ç¹•ã‚¹ãƒ‘ãƒ³ã€ã§å‰²ã£ãŸé¡ã‚’æœˆé¡è²»ç”¨ã¨ã—ã¦ä»®æƒ³çš„ã«ç©ç«‹è¨ˆç®—ã€‚<br>
            * <b>è³ƒè²¸</b>: å®¶è³ƒã«åŠ ãˆã¦ã€2å¹´ã”ã¨ã®æ›´æ–°æ–™(å®¶è³ƒ1ãƒ¶æœˆåˆ†)ã‚’è‡ªå‹•åŠ ç®—ã€‚
        </div>

        <button class="close-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    let activeTab = 'rent';
    let mainChart = null;
    let miniCharts = {};

    const store = {
        rent: { price: 18, taxType: 'none', depr: 0, minRes: 0 },
        nm: { price: 7000, maint: 1.0, shuzen: 1.0, rate_inc: 3.0, taxType: '4500', depr: 1.8, minRes: 50, kotei: 15 },
        om: { price: 6500, ref: 100, maint: 1.5, shuzen: 1.5, rate_inc: 3.0, taxType: '3000', depr: 1.2, minRes: 60, kotei: 12 },
        nh: { price: 6500, shuzen_total: 300, span: 15, taxType: '4500', depr: 3.5, minRes: 50, kotei: 12 },
        oh: { price: 6000, ref: 100, shuzen_total: 300, span: 15, taxType: '3000', depr: 2.0, minRes: 65, kotei: 10 }
    };

    const config = {
        rent: { label: 'è³ƒè²¸', color: '#16a34a' },
        nm: { label: 'æ–°ç¯‰ãƒãƒ³', color: '#2563eb' },
        om: { label: 'ä¸­å¤ãƒãƒ³', color: '#0ea5e9' },
        nh: { label: 'æ–°ç¯‰æˆ¸å»º', color: '#ea580c' },
        oh: { label: 'ä¸­å¤æˆ¸å»º', color: '#8b5cf6' }
    };

    function switchTab(type, btn) {
        saveCurrentValues();
        activeTab = type;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderInputs();
        liveCalc();
    }

    function saveCurrentValues() {
        const pInput = document.getElementById('val_price');
        if(!pInput) return;
        const s = store[activeTab];
        s.price = parseFloat(pInput.value || 0);
        if(activeTab !== 'rent') {
            ['ref','maint','shuzen','rate_inc','shuzen_total','span','depr','minres','kotei'].forEach(key => {
                const el = document.getElementById('val_' + key);
                if(el) s[key === 'minres' ? 'minRes' : key] = parseFloat(el.value || 0);
            });
            s.taxType = document.getElementById('val_tax_type').value;
        }
    }

    function renderInputs() {
        const area = document.getElementById('input-area');
        const s = store[activeTab];
        let html = `<div class="field"><label>${activeTab==='rent'?'å®¶è³ƒ (ä¸‡)':'ä¾¡æ ¼ (ä¸‡)'}</label><input type="number" id="val_price" value="${s.price}" oninput="liveCalc()"></div>`;
        if(activeTab !== 'rent') {
            if(activeTab.includes('o')) html += `<div class="field"><label>ãƒªãƒ•ã‚©ãƒ¼ãƒ  (ä¸‡)</label><input type="number" id="val_ref" value="${s.ref}" oninput="liveCalc()"></div>`;
            if(activeTab.includes('m')) {
                html += `<div class="field"><label>ç®¡ç†è²» (ä¸‡)</label><input type="number" id="val_maint" value="${s.maint}" oninput="liveCalc()"></div><div class="field"><label>ä¿®ç¹•é‡‘ (ä¸‡)</label><input type="number" id="val_shuzen" value="${s.shuzen}" oninput="liveCalc()"></div><div class="field"><label>ä¸Šæ˜‡ç‡ (%)</label><input type="number" id="val_rate_inc" value="${s.rate_inc}" step="0.1" oninput="liveCalc()"></div>`;
            } else {
                html += `<div class="field"><label>ä¿®ç¹•ç·é¡ (ä¸‡)</label><input type="number" id="val_shuzen_total" value="${s.shuzen_total}" oninput="liveCalc()"></div><div class="field"><label>ã‚¹ãƒ‘ãƒ³ (å¹´)</label><input type="number" id="val_span" value="${s.span}" oninput="liveCalc()"></div>`;
            }
            html += `<div class="field"><label>å›ºç¨ (å¹´/ä¸‡)</label><input type="number" id="val_kotei" value="${s.kotei}" oninput="liveCalc()"></div><div class="field"><label>æ¸›ä¾¡ç‡ (%)</label><input type="number" id="val_depr" value="${s.depr}" step="0.1" oninput="liveCalc()"></div><div class="field"><label>ä¸‹é™ (%)</label><input type="number" id="val_minres" value="${s.minRes}" oninput="liveCalc()"></div>`;
            html += `<div class="field"><label>æ§é™¤åŒºåˆ†</label><select id="val_tax_type" onchange="liveCalc()"><option value="4500" ${s.taxType==='4500'?'selected':''}>é•·æœŸå„ªè‰¯</option><option value="3500" ${s.taxType==='3500'?'selected':''}>ZEH</option><option value="3000" ${s.taxType==='3000'?'selected':''}>çœã‚¨ãƒ</option><option value="2000" ${s.taxType==='2000'?'selected':''}>ä¸€èˆ¬ä¸­å¤</option></select></div>`;
        }
        area.innerHTML = html;
    }

    function getLoanMonthly(p, r, n) {
        if(r === 0) return { total: p / (n * 12), interest: 0 };
        const ir = r / 100 / 12, im = n * 12;
        const total = p * ir * Math.pow(1 + ir, im) / (Math.pow(1 + ir, im) - 1);
        return { total, interest: p * ir };
    }

    function liveCalc() {
        saveCurrentValues();
        const gRate = parseFloat(document.getElementById('global_rate').value);
        const gTerm = parseFloat(document.getElementById('global_term').value);
        const grid = document.getElementById('comp_grid');
        grid.innerHTML = '';

        Object.keys(config).forEach(id => {
            const s = store[id];
            let p = 0, i = 0, m = 0;
            if(id === 'rent') { p = s.price; m = s.price / 24; }
            else {
                const res = getLoanMonthly(s.price, gRate, gTerm);
                p = res.total - res.interest; i = res.interest;
                m = id.includes('m') ? (s.maint + s.shuzen + (s.kotei/12)) : (s.shuzen_total / (s.span * 12) + (s.kotei/12));
            }
            grid.innerHTML += `<div class="comp-item"><div class="comp-label"><span style="color:${config[id].color}">â—</span> ${config[id].label}</div><div style="height:40px;"><canvas id="mini_${id}"></canvas></div><div class="comp-value">${(p + i + m).toFixed(1)} ä¸‡å††/æœˆ</div></div>`;
            setTimeout(() => {
                const ctx = document.getElementById(`mini_${id}`).getContext('2d');
                if(miniCharts[id]) miniCharts[id].destroy();
                miniCharts[id] = new Chart(ctx, { type: 'bar', indexAxis: 'y', data: { labels: [''], datasets: [{ label: 'å…ƒé‡‘', data: [p], backgroundColor: config[id].color }, { label: 'åˆ©æ¯', data: [i], backgroundColor: '#fda4af' }, { label: 'ç¶­æŒ', data: [m], backgroundColor: '#94a3b8' }] }, options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } } } });
            }, 0);
        });
    }

    function runSimulation() {
        saveCurrentValues();
        document.getElementById('resultArea').style.display = 'block';
        const exitYear = parseInt(document.getElementById('exit_year').value);
        const pair = parseInt(document.getElementById('is_pair').value);
        const child = parseInt(document.getElementById('is_child').value);
        const gRate = parseFloat(document.getElementById('global_rate').value);
        const gTerm = parseInt(document.getElementById('global_term').value);
        const showGross = document.getElementById('show_gross').checked;
        const showNet = document.getElementById('show_net').checked;

        let datasets = [], tableRows = '';

        Object.keys(config).forEach(id => {
            const s = store[id];
            let historyNet = [], historyGross = [], currentMaint = 0, currentTaxC = 0;
            let loanRem = s.price, curSz = s.shuzen || 0;
            const res = getLoanMonthly(s.price, gRate, gTerm);
            const init = id === 'rent' ? s.price * 5 : (s.price * 0.07) + (s.ref || 0);
            let rowAtExit = {};

            for(let y=1; y<=50; y++) {
                if(id === 'rent') {
                    currentMaint += (s.price * 12 + (y % 2 === 0 ? s.price : 0));
                    const gross = init + currentMaint;
                    historyGross.push(gross); historyNet.push(gross);
                    if(y === exitYear) rowAtExit = { lp: 0, init, maint: currentMaint, tax: 0, asset: 0, cost: gross };
                } else {
                    const totalPaidLoan = res.total * 12 * Math.min(y, gTerm);
                    if(y <= gTerm) {
                        for(let m=0; m<12; m++) {
                            const mi = Math.max(0, loanRem) * (gRate / 100 / 12);
                            loanRem -= (res.total - mi);
                        }
                    }
                    currentMaint += (id.includes('m') ? (s.maint + curSz) * 12 : (s.shuzen_total / (s.span || 15))) + (s.kotei || 0);
                    if(id.includes('m')) curSz *= (1 + (s.rate_inc / 100));

                    let limit = parseInt(s.taxType);
                    if(child == 1) { if(limit === 4500) limit = 5000; else if(limit === 3500) limit = 4500; else if(limit === 3000) limit = 4000; }
                    if(y <= (id.includes('n') ? 13 : 10)) currentTaxC += Math.min(Math.max(loanRem, 0), limit * pair) * 0.007;
                    
                    const asset = Math.max(s.price * (1 - (s.depr / 100) * y), s.price * (s.minRes / 100));
                    const gross = init + totalPaidLoan + currentMaint;
                    const net = gross - asset - currentTaxC;

                    historyGross.push(Math.round(gross)); 
                    historyNet.push(Math.round(net));
                    if(y === exitYear) rowAtExit = { lp: totalPaidLoan, init, maint: currentMaint, tax: currentTaxC, asset, cost: net };
                }
            }

            if(showGross) datasets.push({ label: config[id].label + '(è² æ‹…)', data: historyGross, borderColor: config[id].color, pointRadius: 0, tension: 0.1 });
            if(showNet) datasets.push({ label: config[id].label + '(å®Ÿè³ª)', data: historyNet, borderColor: config[id].color, borderDash: [5, 5], pointRadius: 0, tension: 0.1 });
            
            tableRows += `<tr><td class="row-label" style="border-left-color:${config[id].color}">${config[id].label}</td><td>${Math.round(rowAtExit.lp).toLocaleString()}ä¸‡</td><td>${Math.round(rowAtExit.init).toLocaleString()}ä¸‡</td><td>${Math.round(rowAtExit.maint).toLocaleString()}ä¸‡</td><td style="color:var(--color-rent)">-${Math.round(rowAtExit.tax).toLocaleString()}ä¸‡</td><td style="background:#fff7ed">${Math.round(rowAtExit.asset).toLocaleString()}ä¸‡</td><td style="background:#f0f9ff; font-weight:bold;">${Math.round(rowAtExit.cost).toLocaleString()}ä¸‡å††</td></tr>`;
        });

        const ctx = document.getElementById('mainChart').getContext('2d');
        if(mainChart) mainChart.destroy();
        mainChart = new Chart(ctx, { type: 'line', data: { labels: Array.from({length: 50}, (_, i) => i + 1 + "å¹´"), datasets: datasets }, options: { scales: { y: { ticks: { callback: v => v.toLocaleString() + 'ä¸‡' } } }, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 15, font: { size: 10 } } } } } });
        document.getElementById('resTable').querySelector('tbody').innerHTML = tableRows;
        document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
    }

    function openModal(id) { document.getElementById('modal-' + id).style.display = 'flex'; }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    window.onload = () => { renderInputs(); liveCalc(); };
</script>
</body>
</html>
